@inherits LayoutComponentBase
@inject IJSRuntime JS

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-header">
            <div class="header-left">
                <span class="app-title">Stedelijk Energiebeheer Eindhoven</span>
            </div>
            <div class="header-right">
                <!-- Dark Mode Toggle -->
                <button class="header-btn" @onclick="ToggleDarkMode" title="@(isDarkMode ? "Lichte modus" : "Donkere modus")">
                    <i class="bi @(isDarkMode ? "bi-sun-fill" : "bi-moon-fill")"></i>
                </button>
                
                <!-- Language Toggle -->
                <button class="header-btn" @onclick="ToggleLanguage" title="@(isEnglish ? "Nederlands" : "English")">
                    <span class="lang-badge">@(isEnglish ? "EN" : "NL")</span>
                </button>
                
                <span class="header-divider">|</span>
                <span class="location-info"><i class="bi bi-geo-alt-fill"></i> Eindhoven</span>
                <span class="datetime">@currentDateTime</span>
            </div>
        </div>

        <article class="content px-4">
            @Body
        </article>

        <footer class="footer">
            <div class="footer-content">
                <span>© @DateTime.Now.Year Gemeente Eindhoven - Stedelijk Energiebeheer</span>
                <span class="footer-links">
                    <a href="/privacy">Privacy</a> | 
                    <a href="/contact">Contact</a> | 
                    <a href="/help">Help</a>
                </span>
            </div>
        </footer>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    Er is een fout opgetreden. <a href="." class="reload">Pagina herladen</a>
</div>

<style>
    .header-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-right: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .header-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.5);
    }
    
    .lang-badge {
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .header-divider {
        margin: 0 0.5rem;
        opacity: 0.5;
    }
    
    .location-info i {
        margin-right: 0.25rem;
    }
</style>

@code {
    private bool isDarkMode = true;
    private bool isEnglish = false;
    private string currentDateTime = "";
    private System.Threading.Timer? clockTimer;

    protected override async Task OnInitializedAsync()
    {
        UpdateDateTime();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load saved preferences
            try
            {
                var theme = await JS.InvokeAsync<string>("localStorage.getItem", "theme");
                isDarkMode = theme != "light";
                
                var lang = await JS.InvokeAsync<string>("localStorage.getItem", "language");
                isEnglish = lang == "en";
                
                // Apply theme
                await ApplyTheme();
                
                // Start real-time clock
                clockTimer = new System.Threading.Timer(async _ =>
                {
                    UpdateDateTime();
                    await InvokeAsync(StateHasChanged);
                }, null, 0, 1000);
                
                StateHasChanged();
            }
            catch { }
        }
    }

    private void UpdateDateTime()
    {
        var culture = isEnglish 
            ? new System.Globalization.CultureInfo("en-US") 
            : new System.Globalization.CultureInfo("nl-NL");
        currentDateTime = DateTime.Now.ToString("dddd d MMMM yyyy HH:mm:ss", culture);
    }

    private async Task ToggleDarkMode()
    {
        isDarkMode = !isDarkMode;
        await ApplyTheme();
        await JS.InvokeVoidAsync("localStorage.setItem", "theme", isDarkMode ? "dark" : "light");
    }

    private async Task ToggleLanguage()
    {
        isEnglish = !isEnglish;
        await JS.InvokeVoidAsync("localStorage.setItem", "language", isEnglish ? "en" : "nl");
        UpdateDateTime();
    }

    private async Task ApplyTheme()
    {
        await JS.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-theme', '{(isDarkMode ? "dark" : "light")}')");
    }

    public void Dispose()
    {
        clockTimer?.Dispose();
    }
}
