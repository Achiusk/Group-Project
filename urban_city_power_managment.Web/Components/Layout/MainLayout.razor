@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject AppStateService AppState
@implements IDisposable
@using urban_city_power_managment.Web.Services

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-header">
            <div class="header-left">
                <span class="app-title">@(AppState.IsEnglish ? "Eindhoven Urban Energy Management" : "Stedelijk Energiebeheer Eindhoven")</span>
            </div>
            <div class="header-right">
                <!-- Dark Mode Toggle -->
                <button class="header-btn" @onclick="ToggleDarkMode" title="@(AppState.IsDarkMode ? (AppState.IsEnglish ? "Light mode" : "Lichte modus") : (AppState.IsEnglish ? "Dark mode" : "Donkere modus"))">
                    <i class="bi @(AppState.IsDarkMode ? "bi-sun-fill" : "bi-moon-fill")"></i>
                </button>
                
                <!-- Language Toggle -->
                <button class="header-btn" @onclick="ToggleLanguage" title="@(AppState.IsEnglish ? "Nederlands" : "English")">
                    <span class="lang-badge">@(AppState.IsEnglish ? "EN" : "NL")</span>
                </button>
                
                <span class="header-divider">|</span>
                <span class="location-info"><i class="bi bi-geo-alt-fill"></i> Eindhoven</span>
                <span class="datetime">@currentDateTime</span>
            </div>
        </div>

        <article class="content px-4">
            @Body
        </article>

        <footer class="footer">
            <div class="footer-content">
                <span>© @DateTime.Now.Year @(AppState.IsEnglish ? "Municipality of Eindhoven - Urban Energy Management" : "Gemeente Eindhoven - Stedelijk Energiebeheer")</span>
                <span class="footer-links">
                    <a href="/privacy">Privacy</a> | 
                    <a href="/contact">Contact</a> | 
                    <a href="/cookies">Cookies</a>
                </span>
            </div>
        </footer>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    @(AppState.IsEnglish ? "An error occurred." : "Er is een fout opgetreden.") <a href="." class="reload">@(AppState.IsEnglish ? "Reload page" : "Pagina herladen")</a>
</div>

<style>
    .header-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-right: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .header-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.5);
    }
    
    .lang-badge {
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .header-divider {
        margin: 0 0.5rem;
        opacity: 0.5;
    }
    
    .location-info i {
        margin-right: 0.25rem;
    }
</style>

@code {
    private string currentDateTime = "";
    private System.Threading.Timer? clockTimer;

    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
        UpdateDateTime();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Load saved preferences from localStorage
                var theme = await JS.InvokeAsync<string>("localStorage.getItem", "theme");
                AppState.IsDarkMode = theme != "light";
                
                var lang = await JS.InvokeAsync<string>("localStorage.getItem", "language");
                AppState.IsEnglish = lang == "en";
                
                // Apply theme to DOM
                await ApplyTheme();
                
                // Start real-time clock
                clockTimer = new System.Threading.Timer(async _ =>
                {
                    UpdateDateTime();
                    await InvokeAsync(StateHasChanged);
                }, null, 0, 1000);
                
                StateHasChanged();
            }
            catch { }
        }
    }

    private void UpdateDateTime()
    {
        var culture = AppState.IsEnglish 
            ? new System.Globalization.CultureInfo("en-US") 
            : new System.Globalization.CultureInfo("nl-NL");
        currentDateTime = DateTime.Now.ToString("dddd d MMMM yyyy HH:mm:ss", culture);
    }

    private async Task ToggleDarkMode()
    {
        AppState.IsDarkMode = !AppState.IsDarkMode;
        await ApplyTheme();
        await JS.InvokeVoidAsync("localStorage.setItem", "theme", AppState.IsDarkMode ? "dark" : "light");
    }

    private async Task ToggleLanguage()
    {
        AppState.IsEnglish = !AppState.IsEnglish;
        await JS.InvokeVoidAsync("localStorage.setItem", "language", AppState.IsEnglish ? "en" : "nl");
        UpdateDateTime();
    }

    private async Task ApplyTheme()
    {
        var theme = AppState.IsDarkMode ? "dark" : "light";
        await JS.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-theme', '{theme}')");
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
        clockTimer?.Dispose();
    }
}
