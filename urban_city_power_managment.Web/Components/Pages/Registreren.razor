@page "/registreren"
@using urban_city_power_managment.Web.Models
@using urban_city_power_managment.Web.Services
@using System.ComponentModel.DataAnnotations
@inject IAuthService AuthService
@inject IPostalCodeService PostalCodeService
@inject INetbeheerderService NetbeheerderService
@inject NavigationManager Navigation
@inject AppStateService AppState
@implements IDisposable

<PageTitle>@(AppState.IsEnglish ? "Register" : "Registreren") - Mijn Energie</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card register-card shadow-lg border-0">
                <div class="card-header text-white text-center py-4">
                    <h2 class="mb-0"><i class="bi bi-person-plus me-2"></i>@(AppState.IsEnglish ? "Create Account" : "Account Aanmaken")</h2>
                    <p class="mb-0 opacity-75">@(AppState.IsEnglish ? "Register to monitor your energy usage" : "Registreer om je energieverbruik te monitoren")</p>
                </div>
                <div class="card-body p-4">
    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong><i class="bi bi-exclamation-triangle me-2"></i>@(AppState.IsEnglish ? "Error:" : "Fout:")</strong> @errorMessage
                            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
                        </div>
                    }

                    @if (registrationSuccess)
                    {
                        <div class="alert alert-success text-center py-4">
                            <h4><i class="bi bi-check-circle me-2"></i>@(AppState.IsEnglish ? "Registration Successful!" : "Registratie Succesvol!")</h4>
                            <p>@(AppState.IsEnglish ? "Your account has been created. You can now log in." : "Je account is aangemaakt. Je kunt nu inloggen.")</p>
                            <a href="/inloggen" class="btn btn-success btn-lg mt-2">@(AppState.IsEnglish ? "Go to Login" : "Naar Inloggen")</a>
                        </div>
                    }
                    else
                    {
                        <EditForm Model="@model" OnValidSubmit="HandleRegistration">
                            <DataAnnotationsValidator />

                            <!-- Step Indicator -->
                            <div class="step-indicator mb-4">
                                <div class="d-flex justify-content-between">
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        var stepNum = i;
                                        <div class="step @(currentStep >= stepNum ? "active" : "") @(currentStep > stepNum ? "completed" : "")">
                                            <div class="step-circle">@stepNum</div>
                                            <div class="step-label">@GetStepLabel(stepNum)</div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Step 1: Personal Information -->
                            @if (currentStep == 1)
                            {
                                <div class="step-content">
                                    <h4 class="mb-4"><i class="bi bi-person me-2"></i>@(AppState.IsEnglish ? "Personal Details" : "Persoonlijke Gegevens")</h4>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">@(AppState.IsEnglish ? "First Name" : "Voornaam") *</label>
                                            <input type="text" class="form-control" @bind="model.FirstName" placeholder="Jan" />
                                            <ValidationMessage For="@(() => model.FirstName)" />
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">@(AppState.IsEnglish ? "Last Name" : "Achternaam") *</label>
                                            <input type="text" class="form-control" @bind="model.LastName" placeholder="de Vries" />
                                            <ValidationMessage For="@(() => model.LastName)" />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">@(AppState.IsEnglish ? "Date of Birth" : "Geboortedatum") *</label>
                                        <input type="date" class="form-control" @bind="model.DateOfBirth" max="@maxBirthDate" />
                                        <ValidationMessage For="@(() => model.DateOfBirth)" />
                                        @if (model.DateOfBirth.HasValue && !model.IsAtLeast18YearsOld())
                                        {
                                            <div class="text-danger mt-1">
                                                <small><i class="bi bi-exclamation-circle me-1"></i>@(AppState.IsEnglish ? "You must be at least 18 years old" : "Je moet minimaal 18 jaar oud zijn")</small>
                                            </div>
                                        }
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">@(AppState.IsEnglish ? "Email Address" : "E-mailadres") *</label>
                                        <input type="email" class="form-control" @bind="model.Email" placeholder="jan.devries@email.nl" />
                                        <ValidationMessage For="@(() => model.Email)" />
                                    </div>
                                </div>
                            }

                            <!-- Step 2: Address -->
                            @if (currentStep == 2)
                            {
                                <div class="step-content">
                                    <h4 class="mb-4"><i class="bi bi-house me-2"></i>@(AppState.IsEnglish ? "Address Details" : "Adresgegevens")</h4>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">@(AppState.IsEnglish ? "Postal Code" : "Postcode") *</label>
                                            <input type="text" class="form-control" @bind="model.PostalCode" @bind:after="LookupAddress" placeholder="5611 AA" maxlength="7" />
                                            <ValidationMessage For="@(() => model.PostalCode)" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">@(AppState.IsEnglish ? "House Number" : "Huisnummer") *</label>
                                            <input type="text" class="form-control" @bind="model.HouseNumber" @bind:after="LookupAddress" placeholder="123" />
                                            <ValidationMessage For="@(() => model.HouseNumber)" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">@(AppState.IsEnglish ? "Addition" : "Toevoeging")</label>
                                            <input type="text" class="form-control" @bind="model.HouseNumberAddition" placeholder="A, bis, etc." />
                                        </div>
                                    </div>

                                    @if (isLookingUpAddress)
                                    {
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            <span class="ms-2">@(AppState.IsEnglish ? "Looking up address..." : "Adres opzoeken...")</span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(model.Street))
                                    {
                                        <div class="alert alert-success">
                                            <strong><i class="bi bi-check-circle me-2"></i>@(AppState.IsEnglish ? "Address found:" : "Adres gevonden:")</strong><br />
                                            @model.Street @model.HouseNumber@(model.HouseNumberAddition)<br />
                                            @model.PostalCode.ToUpper() @model.City
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Step 3: Smart Meter -->
                            @if (currentStep == 3)
                            {
                                <div class="step-content">
                                    <h4 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>@(AppState.IsEnglish ? "Smart Meter" : "Slimme Meter")</h4>
                                    
                                    <div class="row justify-content-center mb-4">
                                        <div class="col-md-5">
                                            <div class="card smart-meter-option @(model.HasSmartMeter == true ? "selected" : "")" @onclick="() => SelectSmartMeter(true)">
                                                <div class="card-body text-center py-4">
                                                    <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                                    <h5 class="mt-3">@(AppState.IsEnglish ? "Yes, I have a smart meter" : "Ja, ik heb een slimme meter")</h5>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="card smart-meter-option @(model.HasSmartMeter == false ? "selected" : "")" @onclick="() => SelectSmartMeter(false)">
                                                <div class="card-body text-center py-4">
                                                    <i class="bi bi-x-circle-fill text-secondary" style="font-size: 3rem;"></i>
                                                    <h5 class="mt-3">@(AppState.IsEnglish ? "No, I don't have a smart meter" : "Nee, ik heb geen slimme meter")</h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Step 4: Password -->
                            @if (currentStep == 4)
                            {
                                <div class="step-content">
                                    <h4 class="mb-4"><i class="bi bi-shield-lock me-2"></i>@(AppState.IsEnglish ? "Password" : "Wachtwoord")</h4>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">@(AppState.IsEnglish ? "Password" : "Wachtwoord") *</label>
                                        <div class="input-group">
                                            <input type="@(showPassword ? "text" : "password")" class="form-control" @bind="model.Password" @bind:after="CheckPasswordStrength" placeholder="@(AppState.IsEnglish ? "Minimum 8 characters" : "Minimaal 8 karakters")" />
                                            <button class="btn btn-outline-secondary" type="button" @onclick="TogglePassword">
                                                <i class="bi @(showPassword ? "bi-eye-slash" : "bi-eye")"></i>
                                            </button>
                                        </div>
                                        <ValidationMessage For="@(() => model.Password)" />
                                        
                                        <div class="password-strength mt-2">
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar @GetPasswordStrengthClass()" style="width: @GetPasswordStrengthWidth()%"></div>
                                            </div>
                                            <small class="@GetPasswordStrengthTextClass()">@GetPasswordStrengthText()</small>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">@(AppState.IsEnglish ? "Confirm Password" : "Bevestig Wachtwoord") *</label>
                                        <input type="password" class="form-control" @bind="model.ConfirmPassword" placeholder="@(AppState.IsEnglish ? "Repeat your password" : "Herhaal je wachtwoord")" />
                                        <ValidationMessage For="@(() => model.ConfirmPassword)" />
                                    </div>

                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="acceptTerms" @bind="model.AcceptTerms" />
                                        <label class="form-check-label" for="acceptTerms">
                                            @(AppState.IsEnglish ? "I agree to the" : "Ik ga akkoord met de") <a href="/voorwaarden" target="_blank">@(AppState.IsEnglish ? "terms and conditions" : "algemene voorwaarden")</a> 
                                            @(AppState.IsEnglish ? "and" : "en het") <a href="/privacy" target="_blank">@(AppState.IsEnglish ? "privacy policy" : "privacybeleid")</a> *
                                        </label>
                                    </div>
                                </div>
                            }

                            <!-- Navigation Buttons -->
                            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                                <button type="button" class="btn btn-outline-secondary" @onclick="PreviousStep" disabled="@(currentStep == 1)">
                                    <i class="bi bi-arrow-left me-1"></i> @(AppState.IsEnglish ? "Previous" : "Vorige")
                                </button>
                                
                                @if (currentStep < 4)
                                {
                                    <button type="button" class="btn btn-primary" @onclick="NextStep" disabled="@(!CanProceedToNextStep())">
                                        @(AppState.IsEnglish ? "Next" : "Volgende") <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-success btn-lg" disabled="@(!CanSubmit() || isSubmitting)">
                                        @if (isSubmitting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        }
                                        @(AppState.IsEnglish ? "Create Account" : "Account Aanmaken")
                                    </button>
                                }
                            </div>
                        </EditForm>
                    }
                </div>
                <div class="card-footer text-center py-3">
                    @(AppState.IsEnglish ? "Already have an account?" : "Al een account?") <a href="/inloggen" class="fw-bold">@(AppState.IsEnglish ? "Login" : "Inloggen")</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .register-card { background-color: #ffffff; }
    .register-card .card-header { background: linear-gradient(135deg, #154273, #01689b); border-bottom: none; }
    .register-card .card-body { background-color: #ffffff; }
    .register-card .card-footer { background-color: #f8f9fa; }
    .step-indicator { padding: 0 20px; }
    .step { flex: 1; text-align: center; position: relative; }
    .step:not(:last-child)::after { content: ''; position: absolute; top: 15px; left: 50%; width: 100%; height: 2px; background: #dee2e6; z-index: 0; }
    .step.completed:not(:last-child)::after { background: #198754; }
    .step-circle { width: 35px; height: 35px; border-radius: 50%; background: #dee2e6; color: #6c757d; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; position: relative; z-index: 1; }
    .step.active .step-circle { background: #0d6efd; color: white; }
    .step.completed .step-circle { background: #198754; color: white; }
    .step-label { font-size: 0.8rem; color: #6c757d; margin-top: 5px; }
    .step.active .step-label { color: #0d6efd; font-weight: 500; }
    .smart-meter-option { cursor: pointer; transition: all 0.2s; border: 2px solid #dee2e6; }
    .smart-meter-option:hover { border-color: #0d6efd; transform: translateY(-2px); }
    .smart-meter-option.selected { border-color: #0d6efd; background: #e7f1ff; }
    
    /* Dark mode */
    [data-theme="dark"] .register-card { background-color: #1e1e1e !important; border-color: #333 !important; }
    [data-theme="dark"] .register-card .card-body { background-color: #1e1e1e !important; color: #ffffff !important; }
    [data-theme="dark"] .register-card .card-footer { background-color: #2a2a2a !important; border-top-color: #333 !important; color: #ccc !important; }
    [data-theme="dark"] .register-card .form-control { background-color: #2a2a2a !important; border-color: #444 !important; color: #ffffff !important; }
    [data-theme="dark"] .register-card .form-control:focus { background-color: #2a2a2a !important; border-color: #01689b !important; }
    [data-theme="dark"] .register-card .form-control::placeholder { color: #888 !important; }
    [data-theme="dark"] .register-card .btn-outline-secondary { color: #aaa !important; border-color: #444 !important; }
    [data-theme="dark"] .register-card .btn-outline-secondary:hover { background-color: #333 !important; color: #fff !important; }
    [data-theme="dark"] .register-card .border-top { border-top-color: #444 !important; }
    [data-theme="dark"] .smart-meter-option { background-color: #2a2a2a !important; border-color: #444 !important; }
    [data-theme="dark"] .smart-meter-option:hover { border-color: #01689b !important; }
    [data-theme="dark"] .smart-meter-option.selected { border-color: #01689b !important; background-color: rgba(1, 104, 155, 0.2) !important; }
    [data-theme="dark"] .step-circle { background: #444 !important; color: #aaa !important; }
    [data-theme="dark"] .step:not(:last-child)::after { background: #444 !important; }
    [data-theme="dark"] .step-label { color: #aaa !important; }
    [data-theme="dark"] .form-label { color: #fff !important; }
    [data-theme="dark"] .form-check-label { color: #ccc !important; }
</style>

@code {
    private RegistrationModel model = new();
    private int currentStep = 1;
    private bool showPassword = false;
    private bool isSubmitting = false;
    private bool isLookingUpAddress = false;
    private bool addressLookupFailed = false;
    private bool registrationSuccess = false;
    private string errorMessage = string.Empty;
    private Netbeheerder? netbeheerder;
  
    private string maxBirthDate => DateTime.Today.AddYears(-18).ToString("yyyy-MM-dd");
    
    private bool HasLowercase => !string.IsNullOrEmpty(model.Password) && model.Password.Any(char.IsLower);
    private bool HasUppercase => !string.IsNullOrEmpty(model.Password) && model.Password.Any(char.IsUpper);
    private bool HasNumber => !string.IsNullOrEmpty(model.Password) && model.Password.Any(char.IsDigit);
    private bool HasSpecial => !string.IsNullOrEmpty(model.Password) && model.Password.Any(c => "!@#$%^&*()_+-=[]{}|;':\",./<>?".Contains(c));
    private bool HasMinLength => !string.IsNullOrEmpty(model.Password) && model.Password.Length >= 8;

    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        if (await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/dashboard");
        }
    }

    private string GetStepLabel(int step) => AppState.IsEnglish 
        ? step switch { 1 => "Details", 2 => "Address", 3 => "Meter", 4 => "Password", _ => "" }
        : step switch { 1 => "Gegevens", 2 => "Adres", 3 => "Meter", 4 => "Wachtwoord", _ => "" };

    private async Task LookupAddress()
    {
        if (string.IsNullOrWhiteSpace(model.PostalCode) || model.PostalCode.Length < 6 || string.IsNullOrWhiteSpace(model.HouseNumber)) return;
        isLookingUpAddress = true;
        addressLookupFailed = false;
        StateHasChanged();
        try
        {
            var address = await PostalCodeService.LookupAddressAsync(model.PostalCode, model.HouseNumber, model.HouseNumberAddition);
            if (address != null)
            {
                model.Street = address.Street;
                model.City = address.City;
                model.PostalCode = address.PostalCode;
                netbeheerder = await NetbeheerderService.GetNetbeheerderByPostalCodeAsync(model.PostalCode);
            }
            else { addressLookupFailed = true; model.Street = string.Empty; model.City = string.Empty; }
        }
        catch { addressLookupFailed = true; }
        finally { isLookingUpAddress = false; }
    }

    private void SelectSmartMeter(bool hasSmartMeter) { model.HasSmartMeter = hasSmartMeter; }
    private void CheckPasswordStrength() { StateHasChanged(); }
    private void TogglePassword() { showPassword = !showPassword; }

    private string GetPasswordStrengthClass() => model.GetPasswordStrength() switch
    {
        PasswordStrength.Weak => "bg-danger", PasswordStrength.Fair => "bg-warning",
        PasswordStrength.Good => "bg-info", PasswordStrength.Strong => "bg-success", _ => "bg-secondary"
    };

    private int GetPasswordStrengthWidth() => model.GetPasswordStrength() switch
    {
        PasswordStrength.Weak => 25, PasswordStrength.Fair => 50, PasswordStrength.Good => 75, PasswordStrength.Strong => 100, _ => 0
    };

    private string GetPasswordStrengthText() => AppState.IsEnglish
        ? model.GetPasswordStrength() switch { PasswordStrength.Weak => "Weak", PasswordStrength.Fair => "Fair", PasswordStrength.Good => "Good", PasswordStrength.Strong => "Strong!", _ => "" }
        : model.GetPasswordStrength() switch { PasswordStrength.Weak => "Zwak", PasswordStrength.Fair => "Matig", PasswordStrength.Good => "Goed", PasswordStrength.Strong => "Sterk!", _ => "" };

    private string GetPasswordStrengthTextClass() => model.GetPasswordStrength() switch
    {
        PasswordStrength.Weak => "text-danger", PasswordStrength.Fair => "text-warning",
        PasswordStrength.Good => "text-info", PasswordStrength.Strong => "text-success", _ => "text-muted"
    };

    private bool CanProceedToNextStep() => currentStep switch
    {
        1 => !string.IsNullOrWhiteSpace(model.FirstName) && !string.IsNullOrWhiteSpace(model.LastName) && model.DateOfBirth.HasValue && model.IsAtLeast18YearsOld() && !string.IsNullOrWhiteSpace(model.Email),
        2 => !string.IsNullOrWhiteSpace(model.PostalCode) && !string.IsNullOrWhiteSpace(model.HouseNumber) && !string.IsNullOrWhiteSpace(model.Street),
        3 => model.HasSmartMeter.HasValue,
        _ => true
    };

    private bool CanSubmit()
    {
        var (passwordValid, _) = model.ValidatePassword();
        return CanProceedToNextStep() && passwordValid && model.Password == model.ConfirmPassword && model.AcceptTerms;
    }

    private void NextStep() { if (CanProceedToNextStep() && currentStep < 4) currentStep++; }
    private void PreviousStep() { if (currentStep > 1) currentStep--; }

    private async Task HandleRegistration()
    {
        if (!CanSubmit()) return;
        isSubmitting = true;
        errorMessage = string.Empty;
        try
        {
            var (success, message, user) = await AuthService.RegisterAsync(model);
            if (success) { Navigation.NavigateTo("/dashboard", forceLoad: true); }
            else { errorMessage = message; }
        }
        catch { errorMessage = AppState.IsEnglish ? "An unexpected error occurred. Please try again later." : "Er is een onverwachte fout opgetreden. Probeer het later opnieuw."; }
        finally { isSubmitting = false; }
    }

    public void Dispose() { AppState.OnChange -= StateHasChanged; }
}
