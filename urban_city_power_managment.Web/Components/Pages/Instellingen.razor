@page "/instellingen"
@using urban_city_power_managment.Web.Services
@using urban_city_power_managment.Web.Models
@inject IJSRuntime JSRuntime
@inject AppStateService AppState
@inject IAuthService AuthService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>@(AppState.IsEnglish ? "Settings" : "Instellingen") - Mijn Energie</PageTitle>

@if (!isAuthenticated)
{
    <div class="text-center py-5">
        <p>@(AppState.IsEnglish ? "Loading..." : "Laden...")</p>
    </div>
}
else
{
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><span class="icon">&#x2699;&#xFE0F;</span> @(AppState.IsEnglish ? "Settings" : "Instellingen")</h1>
            <p class="lead">@(AppState.IsEnglish ? "Manage your account and preferences" : "Beheer je account en voorkeuren")</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- App Settings (Dark Mode & Language) -->
            <div class="card mb-4 settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><span class="icon">&#x1F3A8;</span> @(AppState.IsEnglish ? "App Settings" : "App Instellingen")</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="setting-item d-flex justify-content-between align-items-center p-3 rounded mb-3">
                                <div>
                                    <strong><span class="icon">&#x1F319;</span> @(AppState.IsEnglish ? "Dark Mode" : "Donkere Modus")</strong>
                                    <p class="setting-description small mb-0">@(AppState.IsEnglish ? "Easier on the eyes at night" : "Prettiger voor je ogen 's nachts")</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="darkModeToggle" 
                                           checked="@AppState.IsDarkMode" @onchange="ToggleDarkMode" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="setting-item d-flex justify-content-between align-items-center p-3 rounded mb-3">
                                <div>
                                    <strong><span class="icon">&#x1F310;</span> @(AppState.IsEnglish ? "Language" : "Taal")</strong>
                                    <p class="setting-description small mb-0">@(AppState.IsEnglish ? "Choose your language" : "Kies je taal")</p>
                                </div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm @(!AppState.IsEnglish ? "btn-primary" : "btn-outline-primary")" 
                                            @onclick="() => SetLanguage(false)">NL</button>
                                    <button type="button" class="btn btn-sm @(AppState.IsEnglish ? "btn-primary" : "btn-outline-primary")" 
                                            @onclick="() => SetLanguage(true)">EN</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Settings -->
            <div class="card mb-4 settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><span class="icon">&#x1F464;</span> @(AppState.IsEnglish ? "My Profile" : "Mijn Profiel")</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">@(AppState.IsEnglish ? "Name" : "Naam")</label>
                            <input type="text" class="form-control" value="@(currentUser != null ? $"{currentUser.FirstName} {currentUser.LastName}" : "")" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@(AppState.IsEnglish ? "Email" : "E-mailadres")</label>
                            <input type="email" class="form-control" value="@(currentUser?.Email ?? "")" readonly />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">@(AppState.IsEnglish ? "Address" : "Adres")</label>
                            <input type="text" class="form-control" value="@(currentUser?.Street ?? "") @(currentUser?.HouseNumber ?? "")" readonly />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@(AppState.IsEnglish ? "Postal Code" : "Postcode")</label>
                            <input type="text" class="form-control" value="@(currentUser?.PostalCode ?? "")" readonly />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@(AppState.IsEnglish ? "City" : "Plaats")</label>
                            <input type="text" class="form-control" value="@(currentUser?.City ?? "")" readonly />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Meter Settings -->
            <div class="card mb-4 settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><span class="icon">&#x1F4CA;</span> @(AppState.IsEnglish ? "My Smart Meter" : "Mijn Slimme Meter")</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">@(AppState.IsEnglish ? "Smart Meter Status" : "Slimme Meter Status")</label>
                            <input type="text" class="form-control" value="@(currentUser?.HasSmartMeter == true ? (AppState.IsEnglish ? "Connected" : "Gekoppeld") : (AppState.IsEnglish ? "Not connected" : "Niet gekoppeld"))" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@(AppState.IsEnglish ? "Grid Operator" : "Netbeheerder")</label>
                            <input type="text" class="form-control" value="@(currentUser?.NetbeheerderName ?? (AppState.IsEnglish ? "Unknown" : "Onbekend"))" readonly />
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong><span class="icon">&#x1F50C;</span> @(AppState.IsEnglish ? "P1 Port" : "P1 Poort")</strong><br />
                        @(AppState.IsEnglish 
                            ? "Your smart meter has a P1 port that allows us to read your consumption. This data is stored securely and used only for you."
                            : "Je slimme meter heeft een P1 poort waarmee we je verbruik kunnen uitlezen. Deze data wordt veilig opgeslagen en alleen voor jou gebruikt.")
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="card mb-4 settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><span class="icon">&#x1F514;</span> @(AppState.IsEnglish ? "Notifications" : "Meldingen")</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="notifyHighUsage" checked>
                        <label class="form-check-label" for="notifyHighUsage">
                            @(AppState.IsEnglish ? "Warn on high consumption" : "Waarschuw bij hoog verbruik")
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="notifyTips" checked>
                        <label class="form-check-label" for="notifyTips">
                            @(AppState.IsEnglish ? "Send me energy saving tips" : "Stuur me energiebespaartips")
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="weeklyReport" checked>
                        <label class="form-check-label" for="weeklyReport">
                            @(AppState.IsEnglish ? "Weekly usage report by email" : "Wekelijks verbruiksoverzicht per e-mail")
                        </label>
                    </div>
                </div>
            </div>

            <!-- Privacy Settings -->
            <div class="card mb-4 settings-card">
                <div class="card-header">
                    <h5 class="mb-0"><span class="icon">&#x1F512;</span> Privacy</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="shareData" checked>
                        <label class="form-check-label" for="shareData">
                            @(AppState.IsEnglish ? "Share anonymized data for neighborhood statistics" : "Deel geanonimiseerde data voor wijkstatistieken")
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="compareNeighbors" checked>
                        <label class="form-check-label" for="compareNeighbors">
                            @(AppState.IsEnglish ? "Compare my usage with the neighborhood" : "Vergelijk mijn verbruik met de wijk")
                        </label>
                    </div>
                    <p class="privacy-note small">
                        @(AppState.IsEnglish 
                            ? "Your personal data is never shared with third parties."
                            : "Je persoonlijke gegevens worden nooit gedeeld met derden.")
                        <a href="/privacy">@(AppState.IsEnglish ? "Read our privacy policy" : "Lees ons privacybeleid")</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Quick Stats -->
            <div class="card mb-4 stats-card">
                <div class="card-header stats-header">
                    <h5 class="mb-0"><span class="icon">&#x1F4C8;</span> @(AppState.IsEnglish ? "My Statistics" : "Mijn Statistieken")</h5>
                </div>
                <div class="card-body">
                    <div class="stat-item mb-3">
                        <small class="stat-label">@(AppState.IsEnglish ? "Member since" : "Lid sinds")</small>
                        <p class="mb-0"><strong>@(currentUser?.CreatedAt.ToString("MMMM yyyy", AppState.IsEnglish ? new System.Globalization.CultureInfo("en-US") : new System.Globalization.CultureInfo("nl-NL")) ?? "-")</strong></p>
                    </div>
                    <div class="stat-item mb-3">
                        <small class="stat-label">@(AppState.IsEnglish ? "Total savings" : "Totale besparing")</small>
                        <p class="mb-0 text-success"><strong>&#x20AC; 234,50</strong></p>
                    </div>
                    <div class="stat-item mb-3">
                        <small class="stat-label">@(AppState.IsEnglish ? "Tips applied" : "Toegepaste tips")</small>
                        <p class="mb-0"><strong>8 @(AppState.IsEnglish ? "of" : "van") 15</strong></p>
                    </div>
                    <div class="stat-item">
                        <small class="stat-label">@(AppState.IsEnglish ? "Energy label" : "Energie label")</small>
                        <p class="mb-0"><span class="badge bg-success fs-5">B</span></p>
                    </div>
                </div>
            </div>

            <!-- Solar Panel Status -->
            <div class="card mb-4 solar-card">
                <div class="card-header solar-header">
                    <h5 class="mb-0"><span class="icon">&#x2600;&#xFE0F;</span> @(AppState.IsEnglish ? "Solar Panels" : "Zonnepanelen")</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="hasSolar" checked="@(currentUser?.HasSmartMeter == true)">
                        <label class="form-check-label" for="hasSolar">
                            @(AppState.IsEnglish ? "I have solar panels" : "Ik heb zonnepanelen")
                        </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@(AppState.IsEnglish ? "Number of panels" : "Aantal panelen")</label>
                        <input type="number" class="form-control" value="12" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@(AppState.IsEnglish ? "Installation year" : "Installatie jaar")</label>
                        <input type="number" class="form-control" value="2022" />
                    </div>
                </div>
            </div>

            <!-- Help -->
            <div class="card help-card">
                <div class="card-body text-center">
                    <h5>@(AppState.IsEnglish ? "Need help?" : "Hulp nodig?")</h5>
                    <p class="help-text small">@(AppState.IsEnglish ? "Contact our customer service" : "Neem contact op met onze klantenservice")</p>
                    <a href="mailto:support@mijnenergie.nl" class="btn btn-outline-primary btn-sm mb-2 w-100">
                        <span class="icon">&#x1F4E7;</span> @(AppState.IsEnglish ? "Email us" : "E-mail ons")
                    </a>
                    <a href="tel:0401234567" class="btn btn-outline-primary btn-sm w-100">
                        <span class="icon">&#x1F4DE;</span> 040-123 4567
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
}

<style>
    .icon {
        font-family: "Segoe UI Emoji", "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Symbol", sans-serif;
    }

    .stat-item {
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
    }
    
    .stat-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .setting-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .setting-description { color: #6c757d; }
    .stat-label { color: #6c757d; }
    .privacy-note { color: #6c757d; }
    .help-text { color: #6c757d; }

    .stats-header {
        background-color: #0d6efd !important;
        color: white !important;
    }

    .solar-header {
        background-color: #ffc107 !important;
        color: #000 !important;
    }

    /* Dark mode */
    [data-theme="dark"] .settings-card,
    [data-theme="dark"] .stats-card,
    [data-theme="dark"] .solar-card,
    [data-theme="dark"] .help-card {
        background-color: #1e1e1e !important;
        border-color: #333 !important;
    }

    [data-theme="dark"] .settings-card .card-header {
        background-color: #2a2a2a !important;
        border-bottom-color: #333 !important;
    }

    [data-theme="dark"] .setting-item {
        background: #2a2a2a !important;
        border-color: #444 !important;
    }

    [data-theme="dark"] .setting-description,
    [data-theme="dark"] .stat-label,
    [data-theme="dark"] .privacy-note,
    [data-theme="dark"] .help-text {
        color: #aaa !important;
    }

    [data-theme="dark"] .stat-item {
        border-color: #333 !important;
    }

    [data-theme="dark"] .form-check-label {
        color: #fff !important;
    }
</style>

@code {
    private bool isAuthenticated = false;
    private UserAccount? currentUser;

    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();
        
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/landing");
            return;
        }

        currentUser = await AuthService.GetCurrentUserAsync();
    }

    private async Task ToggleDarkMode(ChangeEventArgs e)
    {
        AppState.IsDarkMode = (bool)(e.Value ?? false);
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "theme", AppState.IsDarkMode ? "dark" : "light");
            await JSRuntime.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-theme', '{(AppState.IsDarkMode ? "dark" : "light")}')");
        }
        catch { }
    }

    private async Task SetLanguage(bool english)
    {
        AppState.IsEnglish = english;
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "language", AppState.IsEnglish ? "en" : "nl");
        }
        catch { }
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}
